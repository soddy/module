<!DOCTYPE html>
<html>
<head>
    <meta id="viewport" name="viewport" content="width=640,target-densitydpi=device-dpi,user-scalable=no" />
    <title></title>
    <script src="js/lib/jquery-1.9.1.min.js"></script>
    <script src="js/lib/hammer.min.js"></script>
    <script src="js/editPhotoModule.js"></script>
    <script>
        $(function(){
            var canvas=document.getElementById("photoCanvas");
            var ctx=canvas.getContext("2d");
            var img = new Image();
            img.src = 'images/photo.jpg';
            img.onload = function(){
                canvas.width = 500;
                canvas.height = 722;
                ctx.translate(250,361);



//                var tempX,tempY;
//                var panFlag = true;
//                ctx.clearRect(-500,-722,1000,1444);//x2 是为了把原来的图全部抹掉（不留下痕迹）
//                ctx.rotate(90*Math.PI/180);
//                ctx.drawImage(img, -250, -361, 500, 722);
//
//                var editPhotoPanel = document.getElementById('editPhotoPanel');
//                var mc = new Hammer.Manager(editPhotoPanel);
//                var pan = new Hammer.Pan();
//                mc.add([pan]);
//                mc.on("panmove", function(e) {
//                    if(panFlag){
//                        tempX = e.deltaX < 0 ? -32 : 32;
//                        tempY = e.deltaY < 0 ? -32 : 32;
//                        panFlag = false;
//                    }
//                    ctx.clearRect(-500,-722,1000,1444);//x2 是为了把原来的图全部抹掉（不留下痕迹）
//                    ctx.drawImage(img, -250, -361, 500, 722);
//
//                    ctx.translate(e.deltaY -tempY,tempX - e.deltaX);
//                    tempX = e.deltaX;
//                    tempY = e.deltaY;
//                    console.log(e.deltaX);
//                });
//                mc.on('panend', function(e){
//                    panFlag = true;
//                });


                var tempX,tempY;
                var panFlag = true;
                var _top = -250,_left = -361,_width = 500,_height = 722;
                myPan(_top,_left,_width,_height);
                var editPhotoPanel = document.getElementById('editPhotoPanel');
                var mc = new Hammer.Manager(editPhotoPanel);
                var pan = new Hammer.Pan();
                var pinch = new Hammer.Pinch();
                var rotate = new Hammer.Rotate();
                pinch.recognizeWith(rotate);
                mc.add([pinch]);
//                mc.on("panmove", function(e) {
//                    if(panFlag){
//                        tempX = e.deltaX < 0 ? -32 : 32;
//                        tempY = e.deltaY < 0 ? -32 : 32;
//                        panFlag = false;
//                    }
//                    ctx.rotate(2*Math.PI/180);
//                    ctx.translate(e.deltaX - tempX,e.deltaY - tempY);
//                    myPan(_top,_left,_width,_height);
//                    tempX = e.deltaX;
//                    tempY = e.deltaY;
//                });
//                mc.on('panend', function(e){
//                    panFlag = true;
//                });

                mc.on("pinch", function(e) {
                    myPinch(e.scale,_top,_left,_width,_height,e.rotation);
//                    myRotate(e.rotation);
//                    editPhotoPanel.textContent += e.rotation + '\n';
                });
                mc.on('pinchend', function(e){
                    _top = _top*e.scale;
                    _left = _left*e.scale;
                    _width = _width*e.scale;
                    _height = _height*e.scale;
                });


            }

            function myPan(_top,_left,_width,_height)
            {
                ctx.clearRect(-500,-722,1000,1444);//x2 是为了把原来的图全部抹掉（不留下痕迹）
                ctx.drawImage(img, _top, _left, _width, _height);
            }

            function myPinch(scale,_top,_left,_width,_height,rotation){
                ctx.clearRect(-500,-722,1000,1444);
                if(rotation > -100 && rotation < 100){
                    ctx.rotate((rotation/90*2)*Math.PI/180);
                }
                ctx.drawImage(img, _top*scale, _left*scale, _width*scale, _height*scale);
            }
            function myRotate(rotation){
                if(rotation > -100 && rotation < 100){
                    ctx.clearRect(-500,-722,1000,1444);
                    ctx.rotate((rotation/90*2)*Math.PI/180);
                }
                ctx.drawImage(img, -250, -361, 500, 722);
                $('#msg').html(90*Math.PI/180);
                $('#msg').html(rotation);
            }

        });
    </script>
    <style>
        #editPhotoPanel{
            position: absolute;
            width: 518px;
            height: 740px;
            left: 61px;
            top: 100px;
            background: green;
        }
        #editPhotoPanel canvas{
            position: absolute;
            width: 500px;
            height: 722px;
            background: yellow;
            left: 9px;
            top: 9px;
        }
    </style>
</head>
<body>
<div id="msg">0</div>
<div id="editPhotoPanel">
    <canvas id="photoCanvas"></canvas>
</div>
</body>
</html>